<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô üèÜ</h2>
            <a id="refresh-btn" onclick="location.reload()" class="scoreboard-btn" style="background-color: rgb(193, 193, 193);">
                <svg xmlns="http://www.w3.org/2000/svg" width="" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                </svg>
            </a>
            <a href="main.html" class="scoreboard-btn" style="background-color: rgb(90, 113, 205);">‡πÇ‡∏´‡∏ß‡∏ï</a>
            
        </div>
        <div class="leaderboard" id="leaderboard"></div>
        <div class="total-stats">
            ‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="total-score">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            <button id="reset-btn" class="reset-btn">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
        </div>
    </div>

    <!-- Reset Confirmation Dialog -->
    <div id="reset-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.2); max-width: 400px; width: 90%;">
            <h3 style="margin-bottom: 15px; color: #d32f2f;">‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</h3>
            <p style="margin-bottom: 20px;">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "RESET" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <input type="text" id="reset-confirm" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 2px solid #ccc; border-radius: 4px;" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå RESET...">
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="reset-cancel" style="padding: 8px 16px; border: none; border-radius: 20px; background: #e0e0e0; cursor: pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="reset-confirm-btn" style="padding: 8px 16px; border: none; border-radius: 20px; background: #d32f2f; color: white; cursor: pointer;">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('refresh-btn').addEventListener('click', () => location.reload());
        // load optional firebase initializer
        (function(){
            const s = document.createElement('script');
            s.src = 'Storage_Base/firebase.js';
            s.onload = () => {
                if (window.loadFirebase) window.loadFirebase((ok) => {
                    if (ok && window.db) {
                        // fetch votes from Firestore
                        window.db.collection('votes').get().then(snapshot => {
                            const data = {};
                            snapshot.forEach(doc => data[doc.id] = doc.data());
                            if (Object.keys(data).length) {
                                teams = data;
                                localStorage.setItem('teams', JSON.stringify(teams));
                                updateLeaderboard();
                            }
                        }).catch(err => console.error('Firestore read failed', err));
                    }
                });
            };
            document.head.appendChild(s);
        })();

        // Load teams from localStorage, or fall back to defaults
        const defaultTeams = [
            { id: 'thai', name: '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢', icon: 'üìñ' },
            { id: 'math', name: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', icon: 'üìê' },
            { id: 'science_tech', name: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ', icon: 'üî¨' },
            { id: 'social', name: '‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°', icon: 'üåç' },
            { id: 'health', name: '‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤', icon: 'üèÄ' },
            { id: 'art', name: '‡∏®‡∏¥‡∏•‡∏õ‡∏∞', icon: 'üé®' },
            { id: 'career', name: '‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û', icon: 'üíº' },
            { id: 'language', name: '‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®', icon: '‚úàÔ∏è' },
            { id: 'early', name: '‡∏õ‡∏ê‡∏°‡∏ß‡∏±‡∏¢', icon: 'üß∏' }
        ];

        const stored = JSON.parse(localStorage.getItem('teams') || 'null');
        let teams = stored;
        if (!teams) {
            teams = {};
            defaultTeams.forEach(t => teams[t.id] = { name: t.name, score: 0, icon: t.icon });
        }

        function updateLeaderboard() {
            const leaderboard = document.getElementById('leaderboard');
            const totalScoreElement = document.getElementById('total-score');
            const entries = Object.entries(teams);
            const sortedTeams = entries.sort(([,a], [,b]) => b.score - a.score);
            const totalScore = entries.reduce((sum, [, team]) => sum + (team.score || 0), 0);
            const maxScore = entries.length ? Math.max(...entries.map(([,team]) => team.score || 0)) : 0;
            totalScoreElement.textContent = totalScore;
            leaderboard.innerHTML = sortedTeams.map(([id, team], index) => {
                const percentage = maxScore > 0 ? (team.score / maxScore) * 100 : 0;
                const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}`;
                return `
                    <div class="leader-item ${id}">
                        <div class="leader-rank ${rankClass}">${medal}</div>
                        <div class="leader-icon">${team.icon || ''}</div>
                        <div class="leader-info">
                            <div class="leader-name">${team.name || id}</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        <div class="leader-score">${team.score || 0}</div>
                    </div>
                `;
            }).join('');
        }
        updateLeaderboard();

        // Reset functionality
        const resetBtn = document.getElementById('reset-btn');
        const resetDialog = document.getElementById('reset-dialog');
        const resetConfirmInput = document.getElementById('reset-confirm');
        const resetConfirmBtn = document.getElementById('reset-confirm-btn');
        const resetCancelBtn = document.getElementById('reset-cancel');

        resetBtn.addEventListener('click', () => {
            resetDialog.style.display = 'block';
            resetConfirmInput.value = '';
            resetConfirmInput.focus();
        });

        resetCancelBtn.addEventListener('click', () => {
            resetDialog.style.display = 'none';
        });

        resetConfirmInput.addEventListener('input', () => {
            resetConfirmBtn.disabled = resetConfirmInput.value !== 'RESET';
        });

        resetConfirmBtn.addEventListener('click', async () => {
            if (resetConfirmInput.value !== 'RESET') return;

            // Reset all scores to 0
            Object.keys(teams).forEach(id => {
                teams[id].score = 0;
            });

            // Update localStorage
            localStorage.setItem('teams', JSON.stringify(teams));

            // Update Firebase if available
            if (window.db) {
                try {
                    const batch = window.db.batch();
                    Object.entries(teams).forEach(([id, team]) => {
                        batch.set(window.db.collection('votes').doc(id), team);
                    });
                    await batch.commit();
                    console.log('Successfully reset scores in Firebase');
                } catch (err) {
                    console.error('Failed to reset scores in Firebase:', err);
                }
            }

            // Update UI
            updateLeaderboard();
            resetDialog.style.display = 'none';
        });
    </script>
</body>
</html>
